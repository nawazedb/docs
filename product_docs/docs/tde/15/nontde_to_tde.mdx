---
title: "Enable TDE with pg_upgrade"
navTitle: Enable TDE with pg_upgrade
---

This worked example describes how to use `pg_upgrade` to enable TDE on an EDB Postgres Advanced Server 16 (EPAS 16).

## Preparing your upgrade 

Use [pg_dumpall](https://www.postgresql.org/docs/current/app-pg-dumpall.html), [pgBackRest](/supported-open-source/pgbackrest/), or [Barman](/supported-open-source/barman/) to create a backup of your unencrypted source server. 

## Creating an encrypted server 

1.  Create an empty directory for the new server: 
  
    ```
    mkdir /var/lib/edb-as/16/TDE 
    ```

1.  Ensure the `enterprisedb` user owns the directory:

    ```
    sudo chown enterprisedb /var/lib/edb-as/16/TDE
    sudo chgrp /var/lib/edb-as/16/TDE
    ```

1.  Set environment variables to export the wrap and unwrap commands:

    ```
    export PGDATAKEYWRAPCMD='openssl enc -e -aes-128-cbc -pass pass:ok -out %p'
    export PGDATAKEYUNWRAPCMD='openssl enc -d -aes-128-cbc -pass pass:ok -in %p'
    ```

    !!!note Note
       Alternatively, use the `--key-unwrap-command=<command>` and `--key-wrap-command=<command>` arguments when initializing the encrypted server to include the wrap and unwrap commands.
       
       See [Using initdb TDE options](/tde/latest/enabling_tde/#using-initdb-tde-options) for more information on possible configurations.

1.  Initialize the new server with encryption: 
    
    ```
    /usr/lib/edb-as/16/bin/initdb --data-encryption -D /var/lib/edb-as/16/TDE
    ```

    This command initializes a CONFIG directory with all configuration files for the encrypted server.

1.  Modify the port number in the configuration file of the encrypted instance:
    
    This example uses vi, but you can use any text editor: 

    ```
    sudo vi /var/lib/edb-as/16/TDE2/postgresql.conf
    ```

    Uncomment the line with `#port` and change the port number:

    ```
    port                    5590
    ```

    Write, save and exit the editor. 

    ```
    :wq
    ```

1.  Start the encrypted server: 

    ```
    /usr/lib/edb-as/16/bin/pg_ctl -D /var/lib/edb-as/16/TDE -l logfile start
    ```

1.  Connect to the server: 

    ```
    /usr/lib/edb-as/16/bin/psql -p 5590 edb
    ```

    !!!note Note 
       If you are using two different Postgres versions, ensure you use the psql utility of the encrypted server. Otherwise, the system will attempt to use psql from the previous instance.

1.  [Check for TDE presence](/tde/latest/enabling_tde/#checking-for-tde-presence-using-sql) to ensure the new server is encrypted.

## Upgrading to the encrypted server

1.  Stop both servers:
    
    ```
    /usr/lib/edb-as/16/bin/pg_ctl -D /var/lib/edb-as/16/non-TDE stop
    /usr/lib/edb-as/16/bin/pg_ctl -D /var/lib/edb-as/16/TDE stop
    ```

1.  Run the `pg_upgrade` command in check mode to test for incompatibilities. 
    
    With `-b` and `-B`, specify the source and target BIN directories. With `-d` and `-D`, specify the source and target CONFIG directories.
    Ensure you use the `--copy-by-block` option. 

    ```  
    /usr/lib/edb-as/16/bin/pg_upgrade -b /usr/lib/edb-as/16/bin -B /usr/lib/edb-as/16/bin -d /var/lib/edb-as/16/non-TDE -D /var/lib/edb-as/16/TDE --copy-by-block --check
    ```

    !!!note Note
       The `--check` mode performs preliminary checks without executing the command.

1.  Run the `pg_upgrade` command in normal mode to copy data from the source server to the target server: 

    ```
    /usr/lib/edb-as/16/bin/pg_upgrade -b /usr/lib/edb-as/16/bin -B /usr/lib/edb-as/16/bin -d /var/lib/edb-as/16/non-TDE -D /var/lib/edb-as/16/TDE --copy-by-block
    ```

1.  Initialize the encrypted server: 

    ```
    /usr/lib/edb-as/16/bin/pg_ctl -D /var/lib/edb-as/16/TDE start
    ```

1.  Connect to the encrypted database server:

    ```
    /usr/lib/edb-as/16/bin/psql -p 5590 edb
    ```

1.  Perform a spot check to ensure the databases, tables, schemas, and resources you had in the unencrypted server are available in the new server. For example, list all databases:

    ```
    \l
    ```

    Connect to a database, for example `hr`, and search for existing tables: 

    ```
    \c hr 
    SELECT * FROM dept;
    ```

## Cleaning up after upgrade 

After you verify that `pg_upgrade` encrypted the data successfully, perform a cleanup. 

1.  Clean up the database and its statistics: 

    ```
    /usr/lib/edb-as/16/bin/vacuumdb --all --analyze-in-stages
    ```

1.  Remove all data files of the unencrypted server with the script generated by `pg_upgrade`.

    ```
    ./delete_old_cluster.sh
    ```
